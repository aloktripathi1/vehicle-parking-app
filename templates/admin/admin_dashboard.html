{% extends 'base.html' %}

{% block title %}Admin Dashboard - ParkEase{% endblock %}

{% block page_title %}Admin Dashboard{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Add lotData for JavaScript -->
    <script id="lotData" type="application/json">
        {{ lot_data|tojson|safe }}
    </script>
    
    <!-- Add chartData for JavaScript -->
    <script id="chartData" type="application/json">
        {{ chart_data|tojson|safe }}
    </script>
    
    <!-- Welcome Section -->
    <div class="row mb-4">
        <div class="col-md-12">
            <h2 class="fw-bold" style="color: var(--primary-color);">
                <i class="fas fa-tachometer-alt me-2"></i>Admin Dashboard
            </h2>
            <p class="text-muted">Welcome to your parking management control center</p>
        </div>
    </div>

    <!-- Stats Cards Section -->
    <div class="row dashboard-row g-3 mb-4">
        <div class="col-12 col-sm-6 col-lg-4 col-xl">
            <div class="card dashboard-card">
                <div class="card-body p-3 position-relative">
                    <div class="dashboard-icon-circle bg-success bg-opacity-10">
                        <i class="fas fa-money-bill-wave text-success"></i>
                    </div>
                    <h6 class="text-muted mb-2">Total Revenue</h6>
                    <h2 class="mb-2">₹{{ '%.2f' % total_revenue }}</h2>
                    <div class="daily-change {% if revenue_change >= 0 %}text-success{% else %}text-danger{% endif %}">
                        {% if revenue_change >= 0 %}
                            <i class="fas fa-arrow-up"></i>
                        {% else %}
                            <i class="fas fa-arrow-down"></i>
                        {% endif %}
                        ₹{{ '%.2f' % revenue_change|abs }} today
                        <span class="change-percent">({{ '%.1f' % revenue_change_percent|abs }}%)</span>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0 p-3 pt-0">
                    <span class="text-success small">Revenue generated from all parking lots</span>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-lg-4 col-xl">
            <div class="card dashboard-card">
                <div class="card-body p-3 position-relative">
                    <div class="dashboard-icon-circle bg-primary bg-opacity-10">
                        <i class="fas fa-map-marker-alt text-primary"></i>
                    </div>
                    <h6 class="text-muted mb-2">Total Parking Lots</h6>
                    <h2 class="mb-2">{{ parking_lots|length }}</h2>
                </div>
                <div class="card-footer bg-transparent border-0 p-3 pt-0">
                    <a href="{{ url_for('admin.admin_parking_lots') }}" class="text-primary text-decoration-none small">
                        View Details <i class="fas fa-arrow-right ms-2"></i>
                    </a>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-lg-4 col-xl">
            <div class="card dashboard-card">
                <div class="card-body p-3 position-relative">
                    <div class="dashboard-icon-circle bg-success bg-opacity-10">
                        <i class="fas fa-check-circle text-success"></i>
                    </div>
                    <h6 class="text-muted mb-2">Available Spots</h6>
                    <h2 class="mb-2">{{ available_spots }}</h2>
                    <div class="daily-change {% if spot_change >= 0 %}text-success{% else %}text-warning{% endif %}">
                        {% if spot_change >= 0 %}
                            <i class="fas fa-arrow-up"></i>
                        {% else %}
                            <i class="fas fa-arrow-down"></i>
                        {% endif %}
                        {{ spot_change|abs }} spots today
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0 p-3 pt-0">
                    <a href="{{ url_for('admin.admin_parking_lots') }}" class="text-success text-decoration-none small">
                        View Details <i class="fas fa-arrow-right ms-2"></i>
                    </a>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-lg-4 col-xl">
            <div class="card dashboard-card">
                <div class="card-body p-3 position-relative">
                    <div class="dashboard-icon-circle bg-warning bg-opacity-10">
                        <i class="fas fa-car text-warning"></i>
                    </div>
                    <h6 class="text-muted mb-2">Occupied Spots</h6>
                    <h2 class="mb-2">{{ occupied_spots }}</h2>
                    <div class="daily-change {% if spot_change <= 0 %}text-success{% else %}text-warning{% endif %}">
                        {% if spot_change <= 0 %}
                            <i class="fas fa-arrow-down"></i>
                        {% else %}
                            <i class="fas fa-arrow-up"></i>
                        {% endif %}
                        {{ spot_change|abs }} spots today
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0 p-3 pt-0">
                    <a href="{{ url_for('admin.occupied_spots') }}" class="text-warning text-decoration-none small">
                        View Details <i class="fas fa-arrow-right ms-2"></i>
                    </a>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-lg-4 col-xl">
            <div class="card dashboard-card">
                <div class="card-body p-3 position-relative">
                    <div class="dashboard-icon-circle bg-info bg-opacity-10">
                        <i class="fas fa-users text-info"></i>
                    </div>
                    <h6 class="text-muted mb-2">Total Users</h6>
                    <h2 class="mb-2">{{ users }}</h2>
                    <div class="daily-change {% if user_change >= 0 %}text-success{% else %}text-danger{% endif %}">
                        {% if user_change >= 0 %}
                            <i class="fas fa-arrow-up"></i>
                        {% else %}
                            <i class="fas fa-arrow-down"></i>
                        {% endif %}
                        {{ user_change|abs }} users today
                        <span class="change-percent">({{ '%.1f' % user_change_percent|abs }}%)</span>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0 p-3 pt-0">
                    <a href="{{ url_for('admin.admin_users') }}" class="text-info text-decoration-none small">
                        View Details <i class="fas fa-arrow-right ms-2"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row dashboard-row g-3 mb-4">
        <div class="col-12 col-lg-8">
            <div class="card dashboard-card h-100">
                <div class="card-header p-3">
                    <h6 class="m-0 font-weight-bold text-primary">Revenue by Parking Lot</h6>
                </div>
                <div class="card-body p-3">
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-4">
            <div class="card dashboard-card h-100">
                <div class="card-header p-3">
                    <h6 class="m-0 font-weight-bold text-primary">Spot Status by Parking Lot</h6>
                </div>
                <div class="card-body p-3 d-flex align-items-center justify-content-center">
                    <div class="pie-chart-container">
                        <canvas id="spotStatusChart"></canvas>
                    </div>
                    <div class="d-flex justify-content-center align-items-center mt-2" style="gap: 1.5rem; font-size: 0.95rem;">
                        <span><span style="display:inline-block;width:16px;height:16px;background:rgba(75,192,192,0.8);border-radius:3px;margin-right:6px;"></span>Available</span>
                        <span><span style="display:inline-block;width:16px;height:16px;background:rgba(255,99,132,0.8);border-radius:3px;margin-right:6px;"></span>Occupied</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Table Section -->
    <div class="row dashboard-row">
        <div class="col-12">
            <div class="card dashboard-card">
                <div class="card-header p-3">
                    <h6 class="m-0 font-weight-bold text-primary">Parking Lots</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-container">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th class="px-3">ID</th>
                                    <th class="px-3">Location Name</th>
                                    <th class="px-3">Price/Hour</th>
                                    <th class="px-3">Address</th>
                                    <th class="px-3">Pincode</th>
                                    <th class="px-3">Max Spots</th>
                                    <th class="px-3">Created At</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for lot in parking_lots %}
                                <tr>
                                    <td class="px-3">{{ lot.id }}</td>
                                    <td class="px-3">{{ lot.prime_location_name }}</td>
                                    <td class="px-3">₹{{ lot.price }}</td>
                                    <td class="px-3">{{ lot.address }}</td>
                                    <td class="px-3">{{ lot.pincode }}</td>
                                    <td class="px-3">{{ lot.max_spots }}</td>
                                    <td class="px-3">{{ lot.created_at.strftime('%Y-%m-%d') }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    try {
        // Get the data from the template
        const lotData = JSON.parse(document.getElementById('lotData').textContent);
        const chartData = JSON.parse(document.getElementById('chartData').textContent);
        
        // Revenue Chart
        const revenueCtx = document.getElementById('revenueChart').getContext('2d');
        new Chart(revenueCtx, {
            type: 'bar',
            data: {
                labels: lotData.map(lot => lot.name),
                datasets: [{
                    label: 'Revenue (₹)',
                    data: lotData.map(lot => lot.revenue),
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₹' + value;
                            }
                        }
                    }
                }
            }
        });

        // Spot Status Chart
        const spotStatusCtx = document.getElementById('spotStatusChart').getContext('2d');
        new Chart(spotStatusCtx, {
            type: 'pie',
            data: {
                labels: lotData.map(lot => lot.name),
                datasets: [{
                    data: lotData.map(lot => lot.total_spots - lot.occupied_spots),
                    label: 'Available Spots',
                    backgroundColor: lotData.map(() => 'rgba(75, 192, 192, 0.8)'),
                    borderColor: lotData.map(() => 'rgba(75, 192, 192, 1)'),
                    borderWidth: 1
                }, {
                    data: lotData.map(lot => lot.occupied_spots),
                    label: 'Occupied Spots',
                    backgroundColor: lotData.map(() => 'rgba(255, 99, 132, 0.8)'),
                    borderColor: lotData.map(() => 'rgba(255, 99, 132, 1)'),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.chart.data.labels[context.dataIndex] || '';
                                const value = context.raw || 0;
                                const datasetLabel = context.dataset.label || '';
                                return `${label}: ${datasetLabel} - ${value}`;
                            }
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error initializing charts:', error);
        // Show error message to user
        const errorMessage = document.createElement('div');
        errorMessage.className = 'alert alert-danger';
        errorMessage.textContent = 'Error loading charts. Please refresh the page.';
        document.querySelector('.dashboard-container').prepend(errorMessage);
    }
});
</script>
{% endblock %}

{% block head %}

{% endblock %}
